# Koffi-Curl 实现路线图

本文档概述了将 Python 的 curl_cffi 库移植到 Node.js 平台使用 koffi 框架的实现计划。

## 移植思路详解

### Python 到 Node.js 映射关系

| Python 概念 | Node.js 对应方案 | 实现方法 |
|------------|----------------|---------|
| CFFI 绑定 | koffi 绑定 | 重写 cdef.c 中的声明为 koffi 格式 |
| Python 类 | ES6+ 类 | 使用 class 语法实现相同功能 |
| BytesIO | Buffer | 使用 Node.js Buffer 处理二进制数据 |
| asyncio | Promise/async-await | 重构异步模型使用原生 Promise |
| 装饰器 | 高阶函数 | 使用函数包装替代装饰器模式 |
| 异常处理 | Error 类 | 创建专用错误类型继承自 Error |
| 上下文管理器 | 手动资源管理 | 提供显式 close() 方法 |
| 模块导入 | ES 模块系统 | 使用 import/export 构建模块体系 |

### 核心组件移植策略

1. **常量定义 (const.py → constants.js)**
   - 将 Python 枚举转换为 JS 对象或 Symbol
   - 保持原有命名以便参考对应

2. **底层绑定 (ffi/ → bindings/)**
   - 使用 koffi.struct() 定义 C 结构体
   - 使用 koffi.lib() 加载动态库
   - 重新实现回调函数注册机制

3. **Curl 类 (curl.py → curl.js)**
   - 将方法映射为等效 JS 方法
   - 处理内存和资源管理的差异
   - 适配字符串和缓冲区处理

4. **浏览器指纹 (impersonate.py → fingerprint.js)**
   - 保留相同的浏览器版本映射
   - 重构指纹设置逻辑

5. **会话和请求 (session.py → session.js)**
   - 实现类似接口但使用 JS 习惯
   - 使用 Promise 替代异步上下文管理器

## 可能的挑战和解决方案

1. **内存管理差异**
   - 问题：Python 有 GC，JS 使用垃圾回收但无析构函数
   - 解决：提供显式清理方法，使用 WeakMap 跟踪资源

2. **异步模型转换**
   - 问题：asyncio 和 Promise 有不同的并发模式
   - 解决：设计适合 JS 事件循环的异步接口

3. **二进制数据处理**
   - 问题：Buffer 与 BytesIO 工作方式不同
   - 解决：创建适配器确保二进制数据正确处理

4. **C 回调处理**
   - 问题：koffi 与 CFFI 处理回调方式不同
   - 解决：使用 koffi.callback() 创建稳定回调

5. **跨平台库加载**
   - 问题：确保在不同操作系统上加载正确的库
   - 解决：基于 process.platform 实现平台检测和库路径解析

## 实现顺序建议

从底层到高层逐步构建:
1. 先实现绑定层和常量
2. 构建核心 Curl 类
3. 添加浏览器指纹模拟
4. 实现高级 API
5. 添加异步支持和 WebSocket

这样可以在每个阶段进行测试，确保基础组件正常工作后再构建更高级功能。

## 1. 项目结构与基础设施

- [x] 创建项目结构
- [ ] 设置 npm 包配置
- [ ] 配置构建系统 (webpack/rollup)
- [ ] 添加测试框架 (jest/mocha)

## 2. 核心绑定层

- [ ] 使用 koffi 绑定 libcurl-impersonate
- [ ] 创建 C 函数和结构体的声明
- [ ] 实现内存管理工具
- [ ] 处理回调函数注册

## 3. 核心 Curl 类实现

- [ ] 实现 Curl 类基础功能
- [ ] 添加 setopt/getinfo 接口
- [ ] 实现请求执行逻辑
- [ ] 处理响应和错误

## 4. 浏览器指纹模拟

- [ ] 实现 JA3 指纹设置
- [ ] 实现 HTTP/2 (AKAMAI) 指纹设置
- [ ] 添加常用浏览器预设
- [ ] 支持自定义指纹配置

## 5. 高级 API (类似 axios)

- [ ] 实现 Session 类
- [ ] 添加请求/响应处理
- [ ] 实现 Cookie 管理
- [ ] 支持代理配置

## 6. 异步支持

- [ ] 构建 Promise 包装
- [ ] 实现异步 API
- [ ] 添加并发请求支持
- [ ] 处理事件循环集成

## 7. WebSocket 支持

- [ ] 实现 WebSocket 基础功能
- [ ] 添加事件处理
- [ ] 支持消息收发
- [ ] 集成异步功能

## 8. 文档与示例

- [ ] API 参考文档
- [ ] 使用指南
- [ ] 示例代码
- [ ] 高级用例

## 9. 测试与质量保证

- [ ] 单元测试
- [ ] 集成测试
- [ ] 浏览器指纹验证
- [ ] 性能基准测试

## 10. 发布与维护

- [ ] npm 发布准备
- [ ] 版本策略
- [ ] 更新机制
- [ ] 社区反馈流程